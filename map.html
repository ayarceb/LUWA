<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LUWA Cloud – Domain & Simulation</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>

  <style>
    body {
      font-family: monospace;
      background: #f4f6fa;
      display: flex;
      height: 100vh;
      margin: 0;
    }

    .sidebar {
      width: 260px;
      background: white;
      border: 1px solid #ddd;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 2px 0 6px rgba(0,0,0,0.05);
      overflow-y: auto;
    }

    .sidebar img {
      width: 160px;
      align-self: center;
    }

    button {
      padding: 10px;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
    }

    #maccButton { background: #6f42c1; }
    #saveButton { background: #28a745; }
    #runButton  { background: #d9534f; }
    #stopButton { background: #6c757d; }
    #backButton { background: #007bff; }

    .rightbar {
      width: 420px;
      background: white;
      padding: 16px;
      border-left: 1px solid #ddd;
      overflow-y: auto;
      box-shadow: 2px 0 6px rgba(0,0,0,0.05);
    }

    .map-container {
      flex: 1;
      padding: 6px;
    }

    #map {
      width: 100%;
      height: 100%;
      border-radius: 12px;
    }

    #terminal {
      background: #000;
      color: #0f0;
      padding: 8px;
      height: 220px;
      overflow-y: auto;
      font-size: 0.85rem;
      border-radius: 6px;
    }
  </style>

</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">

  <img src="LOGO.png" alt="LUWA Logo">

  <div><strong>Selected Domain:</strong> <div id="domain-info">None</div></div>

  <label>Start date:</label>
  <input type="date" id="init-date">

  <label>End date:</label>
  <input type="date" id="end-date">

  <!-- NEW BUTTON -->
  <button id="maccButton">MACC GRID</button>

  <button id="saveButton">Save Domain</button>
  <button id="backButton">Back</button>

</div>


<!-- MAP -->
<div class="map-container">
  <div id="map"></div>
</div>


<!-- RIGHT PANEL -->
<div class="rightbar">

  <label>Model:</label>
  <select id="model-select">
    <option value="LOTOS">LOTOS-EUROS</option>
    <option value="WRF">WRF</option>
  </select>

  <label>Nodes <span id="nodes-value">4</span></label>
  <input type="range" id="nodes" min="1" max="64" value="4">

  <button id="runButton">RUN SIMULATION</button>
  <button id="stopButton">STOP SIMULATION</button>

  <div id="terminal">Waiting for simulation…</div>

</div>


<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>

<script>

const API = "https://luwa-consultancy.duckdns.org";  
let bounds = null;
let currentJob = null;
let polling = null;

const token = localStorage.getItem("luwa_token");
if (!token) window.location.href = "auth.html";


// ---------------- MAP SETUP ----------------

const map = L.map('map', { center:[20,0], zoom:3 });
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const drawn = new L.FeatureGroup();
map.addLayer(drawn);

map.addControl(new L.Control.Draw({
  draw:{ polygon:false, polyline:false, circle:false, marker:false, circlemarker:false, rectangle:true },
  edit:{ featureGroup: drawn }
}));

map.on(L.Draw.Event.CREATED, e => {
  drawn.clearLayers();
  drawn.addLayer(e.layer);
  bounds = e.layer.getBounds();

  updateDomainInfo();
});

function updateDomainInfo() {
  if (!bounds) return;

  document.getElementById("domain-info").textContent =
    `N:${bounds.getNorth().toFixed(2)} ` +
    `S:${bounds.getSouth().toFixed(2)} ` +
    `E:${bounds.getEast().toFixed(2)} ` +
    `W:${bounds.getWest().toFixed(2)}`;
}


// ---------------- MACC GRID BUTTON ----------------

document.getElementById("maccButton").onclick = () => {

  const MACC = {
    west: -15,
    south: 35,
    east: 35,
    north: 70
  };

  // draw rectangle
  const rect = L.rectangle([
    [MACC.south, MACC.west],
    [MACC.north, MACC.east]
  ]);

  drawn.clearLayers();
  drawn.addLayer(rect);
  bounds = rect.getBounds();
  updateDomainInfo();

  // set dates
  document.getElementById("init-date").value = "2024-08-13";
  document.getElementById("end-date").value  = "2024-08-14";
};


// ---------------- SAVE DOMAIN ----------------

document.getElementById("saveButton").onclick = async () => {
  if (!bounds) return alert("Select domain first.");

  const fd = new URLSearchParams();
  fd.append("token", token);
  fd.append("north", bounds.getNorth());
  fd.append("south", bounds.getSouth());
  fd.append("east", bounds.getEast());
  fd.append("west", bounds.getWest());
  fd.append("init_date", document.getElementById("init-date").value);
  fd.append("end_date", document.getElementById("end-date").value);
  fd.append("model", document.getElementById("model-select").value);
  fd.append("nodes", document.getElementById("nodes").value);

  await fetch(`${API}/save_domain`, {
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body: fd
  });

  alert("Domain saved.");
};


// ---------------- RUN SIMULATION (MACC) ----------------

document.getElementById("runButton").onclick = async () => {
  const terminal = document.getElementById("terminal");
  terminal.textContent = "Launching LOTOS on AWS…";

  const res = await fetch(`${API}/run_macc_simulation`, { method:"POST" });
  const data = await res.json();

  currentJob = data.job_id;

  terminal.textContent = `Job launched: ${currentJob}\nWaiting for LOTOS…`;

  startPolling();
};


// ---------------- POLLING JOB STATUS ----------------

function startPolling() {
  const term = document.getElementById("terminal");

  polling = setInterval(async () => {
    if (!currentJob) return;

    const res = await fetch(`${API}/job_status?job_id=${currentJob}`);
    const data = await res.json();

    term.textContent = data.log;

    if (data.status === "finished") {
      term.textContent += "\n\n[Simulation finished]";
      clearInterval(polling);
    }

  }, 3000);
}


// ---------------- STOP SIMULATION ----------------

document.getElementById("stopButton").onclick = () => {
  alert("Stopping manually is not implemented yet.");
};


// ---------------- BACK BUTTON ----------------

document.getElementById("backButton").onclick = () =>
  window.location.href = "cloud.html";

</script>

</body>
</html>
